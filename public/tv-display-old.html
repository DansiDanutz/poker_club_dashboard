<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Club TV Display</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .container {
            padding: 1vh;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            gap: 1vh;
            position: relative;
        }

        .header {
            text-align: center;
            padding: 1.5vh 2vw;
            /* No default background - show image as-is */
            border-radius: 1vh;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            flex-shrink: 0;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 5vw, 4rem);
            font-weight: 900;
            margin-bottom: 0.5vh;
            text-transform: uppercase;
            background: linear-gradient(45deg, #00d4ff, #00ff88, #00d4ff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
            letter-spacing: 3px;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.8);
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header .subtitle {
            font-size: clamp(1rem, 2.5vw, 1.8rem);
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 5px;
            font-weight: 700;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .content {
            flex: 1;
            display: grid;
            grid-template-columns: minmax(30%, 1fr) minmax(60%, 2fr);
            gap: 2vw;
            min-height: 0;
            padding: 0 1vw;
        }

        /* Responsive adjustments */
        @media (max-aspect-ratio: 16/9) {
            .content {
                grid-template-columns: 1fr 1.5fr;
            }
        }

        @media (min-aspect-ratio: 21/9) {
            .content {
                grid-template-columns: 1fr 2.5fr;
            }
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 1vh;
        }

        .right-section {
            display: flex;
            flex-direction: column;
            gap: 1vh;
        }

        .combined-card {
            flex: 1;
        }

        .image-card {
            border-radius: 2vh;
            border: 3px solid;
            border-image: linear-gradient(45deg, #00ff88, #00d4ff, #00ff88) 1;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 15vh;
            max-height: 25vh;
            overflow: hidden;
            width: 100%;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            animation: imagePulse 3s ease-in-out infinite;
        }

        @keyframes imagePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 50px rgba(0, 255, 136, 0.8);
            }
        }

        /* Removed image card overlay - show background as-is */

        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1vh;
        }

        .image-placeholder {
            color: #666;
            text-align: center;
            font-style: italic;
        }

        .card {
            border-radius: 2vh;
            border: 3px solid;
            border-image: linear-gradient(45deg, #00d4ff, #00ff88, #00d4ff) 1;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5),
                       inset 0 0 30px rgba(0, 212, 255, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            animation: cardPulse 4s ease-in-out infinite;
        }

        @keyframes cardPulse {
            0%, 100% {
                box-shadow: 0 0 30px rgba(0, 212, 255, 0.5),
                           inset 0 0 30px rgba(0, 212, 255, 0.1);
            }
            50% {
                box-shadow: 0 0 50px rgba(0, 255, 136, 0.7),
                           inset 0 0 40px rgba(0, 255, 136, 0.2);
            }
        }

        .card-content {
            position: relative;
            z-index: 2;
            padding: 1.5vh 1.5vw;
            /* No background overlay - show image as-is */
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            margin-bottom: 2vh;
            color: #00d4ff;
            text-align: center;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 1vh 0;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            position: relative;
        }

        .card h2::before,
        .card h2::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 50px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00d4ff);
        }

        .card h2::before {
            left: 0;
        }

        .card h2::after {
            right: 0;
            transform: rotate(180deg);
        }

        .promotion-info {
            text-align: center;
            margin-bottom: 1vh;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .promotion-name {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 3.5vw, 3rem);
            font-weight: 900;
            margin-bottom: 1vh;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(0, 255, 136, 0.8); }
            50% { text-shadow: 0 0 30px rgba(0, 255, 136, 1), 0 0 40px rgba(0, 212, 255, 0.8); }
        }

        .promotion-dates {
            font-size: clamp(0.8rem, 1.5vw, 1.1rem);
            color: #ccc;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5vh 1vw;
            border-radius: 2vh;
            font-weight: bold;
            margin: 0.5vh 0;
            font-size: clamp(0.7rem, 1.2vw, 1rem);
        }

        .status-active {
            background: #00ff88;
            color: #000;
        }

        .status-upcoming {
            background: #ffaa00;
            color: #000;
        }

        .status-complete {
            background: #ff4444;
            color: #fff;
        }

        .leaderboard {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 1vw;
            position: relative;
        }

        .leaderboard::before {
            content: 'TOP 10 PLAYERS';
            position: sticky;
            top: 0;
            display: block;
            text-align: center;
            padding: 1vh 0;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.3), transparent);
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            letter-spacing: 3px;
            margin-bottom: 2vh;
            z-index: 10;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5vh 2vw;
            margin: 1.5vh 0;
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.1), rgba(0, 255, 136, 0.05), transparent);
            border-radius: 1vh;
            border-left: 0.5vw solid #00d4ff;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .leaderboard-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.3), transparent);
            animation: slideRight 10s infinite;
        }

        @keyframes slideRight {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: -100%; }
        }

        .leaderboard-item:hover {
            transform: translateX(10px);
            border-left-color: #00ff88;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
        }

        /* Special styling for top 3 */
        .leaderboard-item:nth-child(1) {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.05), transparent);
            border-left-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .leaderboard-item:nth-child(2) {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.2), rgba(192, 192, 192, 0.05), transparent);
            border-left-color: #c0c0c0;
            box-shadow: 0 0 20px rgba(192, 192, 192, 0.3);
        }

        .leaderboard-item:nth-child(3) {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.2), rgba(205, 127, 50, 0.05), transparent);
            border-left-color: #cd7f32;
            box-shadow: 0 0 20px rgba(205, 127, 50, 0.3);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1vw;
            flex: 1;
        }

        .rank {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 3vw, 3rem);
            font-weight: 900;
            color: #00d4ff;
            min-width: 4vw;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.8);
            position: relative;
        }

        .leaderboard-item:nth-child(1) .rank {
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .leaderboard-item:nth-child(1) .rank::after {
            content: 'üëë';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
        }

        .leaderboard-item:nth-child(2) .rank {
            color: #c0c0c0;
            text-shadow: 0 0 20px rgba(192, 192, 192, 0.8);
        }

        .leaderboard-item:nth-child(3) .rank {
            color: #cd7f32;
            text-shadow: 0 0 20px rgba(205, 127, 50, 0.8);
        }

        .player-name {
            font-weight: 700;
            font-size: clamp(1.8rem, 2.5vw, 2.5rem);
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5),
                        0 0 20px rgba(0, 212, 255, 0.3);
            margin-left: 2vw;
            flex: 1;
        }

        .leaderboard-item:nth-child(1) .player-name {
            background: linear-gradient(45deg, #ffd700, #ffed4b, #ffd700);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
        }

        .player-hours {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 2.8vw, 2.8rem);
            color: #00ff88;
            font-weight: 900;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.8),
                        2px 2px 4px rgba(0, 0, 0, 0.5);
            min-width: 8vw;
            text-align: right;
            position: relative;
        }

        .player-hours::before {
            content: '‚è±Ô∏è';
            position: absolute;
            left: -30px;
            font-size: 1.5rem;
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .rules-content, .prizes-content {
            white-space: pre-wrap;
            line-height: 1.4;
            font-size: clamp(0.8rem, 1.3vw, 1.1rem);
            flex: 1;
            overflow-y: auto;
            color: #ffffff;
        }

        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2vh;
            font-size: clamp(0.8rem, 1.3vw, 1rem);
        }

        .loading {
            text-align: center;
            color: #00d4ff;
            font-size: clamp(0.9rem, 1.5vw, 1.2rem);
            padding: 2vh;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 0.5vw;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5vh;
        }

        ::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 0.5vh;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00ff88;
        }

        /* Enhanced animations */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .updating {
            animation: pulse 1s infinite;
        }

        /* Particle effects background */
        .container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 255, 136, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            animation: particleFloat 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        /* Loading animation */
        .loading {
            text-align: center;
            color: #00d4ff;
            font-size: clamp(1.2rem, 2vw, 1.8rem);
            padding: 3vh;
            font-family: 'Orbitron', sans-serif;
            position: relative;
        }

        .loading::after {
            content: '...';
            position: absolute;
            animation: loadingDots 1.5s infinite;
        }

        @keyframes loadingDots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="club-name">üé∞ Player's Poker Club üé∞</h1>
            <div class="subtitle">Cash Game Promotion</div>
        </div>

        <div class="content">
            <div class="left-section">
                <div class="card" style="flex: 1;" id="rankings-card">
                    <div class="card-content">
                        <h2>üìä Player Rankings</h2>
                        <div id="leaderboard" class="leaderboard">
                            <div class="loading">Loading leaderboard...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-section">
                <div class="image-card" id="promo-image">
                    <div class="image-placeholder">No image uploaded</div>
                </div>

                <div class="card combined-card" id="promotion-rules-card">
                    <div class="card-content">
                        <h2>üèÜ Current Promotion & Rules</h2>
                        <div style="display: flex; flex-direction: column; gap: 2vh; flex: 1;">
                            <div id="promotion-info" class="promotion-info" style="flex: 0 0 auto;">
                                <div class="loading">Loading promotion data...</div>
                            </div>
                            <div style="flex: 1; overflow-y: auto;">
                                <h3 style="font-size: clamp(0.9rem, 2vw, 1.4rem); color: #00d4ff; margin-bottom: 1vh;">üìã Promotion Rules</h3>
                                <div id="rules-content" class="rules-content">
                                    <div class="loading">Loading rules...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" id="prizes-card">
                    <div class="card-content">
                        <h2>üèÜ Prizes & Rewards</h2>
                        <div id="prizes-content" class="prizes-content">
                            <div class="loading">Loading prizes...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.origin;
        const REFRESH_INTERVAL = 30000; // 30 seconds
        const PROMOTION_ROTATION_INTERVAL = 10000; // 10 seconds per promotion (configurable)
        
        // Get rotation settings from localStorage (per promotion configuration)
        function getPromotionRotationTime(promotionId) {
            const settings = JSON.parse(localStorage.getItem('pokerClubTvRotationSettings') || '{}');
            return settings[promotionId] || PROMOTION_ROTATION_INTERVAL;
        }
        
        function setPromotionRotationTime(promotionId, timeMs) {
            const settings = JSON.parse(localStorage.getItem('pokerClubTvRotationSettings') || '{}');
            settings[promotionId] = timeMs;
            localStorage.setItem('pokerClubTvRotationSettings', JSON.stringify(settings));
        }

        // State
        let currentData = {
            promotions: [],
            players: [],
            sessions: [],
            rules: '',
            prizes: ''
        };

        // Rotation state
        let currentPromotionIndex = 0;
        let activePromotions = [];
        let rotationTimer = null;
        let rotationProgressTimer = null;

        // Utility functions
        function sanitizeText(text) {
            if (!text) return '';
            return String(text)
                .replace(/[\uD800-\uDFFF]/g, '')
                .replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
                .replace(/\uFEFF/g, '')
                .trim();
        }

        function formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleDateString();
            } catch {
                return dateString;
            }
        }

        function getPromotionStatus(promotion) {
            const now = new Date();
            const start = new Date(promotion.start_date);
            const end = new Date(promotion.end_date);

            if (now < start) return 'upcoming';
            if (now > end) return 'complete';
            return 'active';
        }

        function calculateLeaderboard(promotion, sessions, players) {
            if (!promotion || !sessions || !players) return [];

            const startDate = new Date(promotion.start_date);
            const endDate = new Date(promotion.end_date);

            // Filter sessions within promotion period
            const promotionSessions = sessions.filter(session => {
                const sessionDate = new Date(session.date);
                return sessionDate >= startDate && sessionDate <= endDate;
            });

            // Calculate player stats
            const playerStats = {};
            promotionSessions.forEach(session => {
                const playerId = session.player_id;
                if (!playerStats[playerId]) {
                    const player = players.find(p => p.id === playerId);
                    playerStats[playerId] = {
                        playerId,
                        name: player ? player.name : 'Unknown Player',
                        totalHours: 0,
                        sessions: 0
                    };
                }

                // Calculate duration from seat_in_time and seat_out_time, fallback to duration field
                const durationMinutes = session.seat_in_time && session.seat_out_time 
                    ? (new Date(session.seat_out_time).getTime() - new Date(session.seat_in_time).getTime()) / (1000 * 60)
                    : (session.duration || 0) * 60;
                
                playerStats[playerId].totalHours += durationMinutes / 60;
                playerStats[playerId].sessions += 1;
            });

            // Sort by total hours
            return Object.values(playerStats)
                .sort((a, b) => b.totalHours - a.totalHours)
                .slice(0, 10); // Top 10
        }

        // API functions
        async function fetchData() {
            try {
                // Try to fetch from localStorage first (fallback)
                const clubSettings = JSON.parse(localStorage.getItem('pokerClubSettings') || '{}');
                const localData = {
                    promotions: JSON.parse(localStorage.getItem('pokerClubPromotions') || '[]'),
                    players: JSON.parse(localStorage.getItem('pokerClubPlayers') || '[]'),
                    sessions: JSON.parse(localStorage.getItem('pokerClubHistory') || '[]'),
                    rules: localStorage.getItem('pokerClubTvRules') || 'No rules available',
                    prizes: localStorage.getItem('pokerClubTvPrices') || 'No prizes available',
                    promoImage: localStorage.getItem('pokerClubTvPromoImage') || '/default-promo-image.jpg',
                    cardBackgrounds: JSON.parse(localStorage.getItem('pokerClubTvCardBackgrounds') || '{}'),
                    clubName: clubSettings.clubName || "Player's Poker Club"
                };

                // Sanitize all text data
                localData.rules = sanitizeText(localData.rules);
                localData.prizes = sanitizeText(localData.prizes);

                currentData = localData;
                updateDisplay();
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('Failed to load data');
            }
        }

        function updateDisplay() {
            updateClubName();
            setupPromotionRotation();
            updateRules();
            updatePrizes();
            updatePromoImage();
            updateCardBackgrounds();
        }

        function updateClubName() {
            const clubNameElement = document.getElementById('club-name');
            if (clubNameElement && currentData.clubName) {
                clubNameElement.textContent = `üé∞ ${currentData.clubName} üé∞`;
            }
        }

        function updateCardBackgrounds() {
            const backgrounds = currentData.cardBackgrounds || {};
            console.log('Applying backgrounds:', backgrounds);

            // Apply header background
            const header = document.querySelector('.header');
            if (header && backgrounds.header) {
                // For base64 data URLs, they already include the data: prefix
                if (backgrounds.header.startsWith('data:')) {
                    header.style.backgroundImage = `url(${backgrounds.header})`;
                } else {
                    header.style.backgroundImage = `url('${backgrounds.header}')`;
                }
                console.log('Applied header background');
            }

            // Apply promo image card background
            const promoImageCard = document.querySelector('.image-card');
            if (promoImageCard && backgrounds.promoImage) {
                if (backgrounds.promoImage.startsWith('data:')) {
                    promoImageCard.style.backgroundImage = `url(${backgrounds.promoImage})`;
                } else {
                    promoImageCard.style.backgroundImage = `url('${backgrounds.promoImage}')`;
                }
                promoImageCard.classList.add('has-background');
                console.log('Applied promo image background');
            }

            // Apply backgrounds to specific cards using IDs
            if (backgrounds.rankings) {
                const rankingsCard = document.getElementById('rankings-card');
                if (rankingsCard) {
                    if (backgrounds.rankings.startsWith('data:')) {
                        rankingsCard.style.backgroundImage = `url(${backgrounds.rankings})`;
                    } else {
                        rankingsCard.style.backgroundImage = `url('${backgrounds.rankings}')`;
                    }
                    console.log('Applied rankings background');
                }
            }

            if (backgrounds.promotionRules) {
                const promoRulesCard = document.getElementById('promotion-rules-card');
                if (promoRulesCard) {
                    try {
                        if (backgrounds.promotionRules.startsWith('data:')) {
                            // For base64, truncate for logging but use full for styling
                            console.log('Applying base64 promotion rules background');
                            promoRulesCard.style.backgroundImage = `url(${backgrounds.promotionRules})`;
                        } else {
                            promoRulesCard.style.backgroundImage = `url('${backgrounds.promotionRules}')`;
                        }
                        console.log('Applied promotion rules background to element:', promoRulesCard);
                        console.log('Background style:', promoRulesCard.style.backgroundImage.substring(0, 100));
                    } catch (e) {
                        console.error('Error applying promotion rules background:', e);
                    }
                }
            }

            if (backgrounds.prizes) {
                const prizesCard = document.getElementById('prizes-card');
                if (prizesCard) {
                    if (backgrounds.prizes.startsWith('data:')) {
                        prizesCard.style.backgroundImage = `url(${backgrounds.prizes})`;
                    } else {
                        prizesCard.style.backgroundImage = `url('${backgrounds.prizes}')`;
                    }
                    console.log('Applied prizes background');
                }
            }
        }

        function setupPromotionRotation() {
            // Clear existing timers
            if (rotationTimer) clearInterval(rotationTimer);
            if (rotationProgressTimer) clearInterval(rotationProgressTimer);
            
            // Get all active promotions
            let allActivePromotions = currentData.promotions.filter(p => getPromotionStatus(p) === 'active');
            
            // Filter out promotions with rotation time set to 0 (excluded from rotation)
            activePromotions = allActivePromotions.filter(p => getPromotionRotationTime(p.id) > 0);
            
            // If no rotatable active promotions, try upcoming, then latest
            if (activePromotions.length === 0) {
                const upcomingPromotions = currentData.promotions.filter(p => 
                    getPromotionStatus(p) === 'upcoming' && getPromotionRotationTime(p.id) > 0
                );
                if (upcomingPromotions.length > 0) {
                    activePromotions = upcomingPromotions;
                } else if (currentData.promotions.length > 0) {
                    // Show the latest promotion even if rotation is disabled
                    activePromotions = [currentData.promotions[currentData.promotions.length - 1]];
                }
            }
            
            currentPromotionIndex = 0;
            
            // Update display immediately
            updatePromotionInfo();
            updateLeaderboard();
            
            // If multiple promotions, start rotation
            if (activePromotions.length > 1) {
                startPromotionRotation();
            }
        }

        function startPromotionRotation() {
            // Clear any existing rotation
            if (rotationTimer) clearInterval(rotationTimer);
            
            function rotateToNext() {
                currentPromotionIndex = (currentPromotionIndex + 1) % activePromotions.length;
                updatePromotionInfo();
                updateLeaderboard();
                updateRotationProgress();
                scheduleNextRotation();
            }
            
            function scheduleNextRotation() {
                if (activePromotions.length <= 1) return;
                
                const currentPromotion = activePromotions[currentPromotionIndex];
                const rotationTime = getPromotionRotationTime(currentPromotion.id);
                
                if (rotationTime > 0) {
                    rotationTimer = setTimeout(rotateToNext, rotationTime);
                }
            }
            
            // Start progress indicator and schedule first rotation
            updateRotationProgress();
            scheduleNextRotation();
        }

        function updateRotationProgress() {
            // Visual feedback for rotation (progress bar)
            const progressElement = document.getElementById('rotation-progress');
            if (progressElement && activePromotions.length > 1) {
                const currentPromotion = activePromotions[currentPromotionIndex];
                const rotationTime = getPromotionRotationTime(currentPromotion.id);
                
                progressElement.style.width = '0%';
                progressElement.style.transition = 'none';
                
                if (rotationTime > 0) {
                    setTimeout(() => {
                        progressElement.style.transition = `width ${rotationTime}ms linear`;
                        progressElement.style.width = '100%';
                    }, 50);
                }
            }
        }

        function updatePromotionInfo() {
            const container = document.getElementById('promotion-info');
            if (!container) return;

            if (activePromotions.length === 0) {
                container.innerHTML = '<div class="no-data">No active promotion</div>';
                return;
            }

            const currentPromotion = activePromotions[currentPromotionIndex];
            const status = getPromotionStatus(currentPromotion);
            const statusClass = `status-${status}`;
            const statusText = status === 'upcoming' ? 'üéØ UPCOMING' :
                             status === 'complete' ? '‚úÖ COMPLETE' : '';

            // Show rotation indicator if multiple promotions
            const rotationIndicator = activePromotions.length > 1 ? `
                <div style="margin-top: 15px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: #00d4ff; font-size: 0.9rem;">
                        <span>üì∫ Showing ${currentPromotionIndex + 1} of ${activePromotions.length}</span>
                        <div style="width: 100px; height: 4px; background: rgba(0, 212, 255, 0.2); border-radius: 2px; overflow: hidden;">
                            <div id="rotation-progress" style="height: 100%; background: #00d4ff; width: 0%; border-radius: 2px;"></div>
                        </div>
                    </div>
                </div>
            ` : '';

            container.innerHTML = `
                <div class="promotion-name">${sanitizeText(currentPromotion.name)}</div>
                <div class="promotion-dates">
                    ${formatDate(currentPromotion.start_date)} - ${formatDate(currentPromotion.end_date)}
                </div>
                ${statusText ? `<div class="status-badge ${statusClass}">${statusText}</div>` : ''}
                ${rotationIndicator}
            `;
        }

        function updateLeaderboard() {
            const container = document.getElementById('leaderboard');
            if (!container) return;

            if (activePromotions.length === 0) {
                container.innerHTML = '<div class="no-data">No promotion data available</div>';
                return;
            }

            const currentPromotion = activePromotions[currentPromotionIndex];
            const leaderboard = calculateLeaderboard(currentPromotion, currentData.sessions, currentData.players);

            if (leaderboard.length === 0) {
                container.innerHTML = '<div class="no-data">No players yet</div>';
                return;
            }

            container.innerHTML = leaderboard.map((player, index) => `
                <div class="leaderboard-item">
                    <div class="player-info">
                        <div class="rank">#${index + 1}</div>
                        <div class="player-name">${sanitizeText(player.name)}</div>
                    </div>
                    <div class="player-hours">${player.totalHours.toFixed(1)}h</div>
                </div>
            `).join('');
        }

        function updateRules() {
            const container = document.getElementById('rules-content');
            if (!container) return;

            container.innerHTML = currentData.rules || '<div class="no-data">No rules available</div>';
        }

        function updatePrizes() {
            const container = document.getElementById('prizes-content');
            if (!container) return;

            container.innerHTML = currentData.prizes || '<div class="no-data">No prizes available</div>';
        }

        function showError(message) {
            const containers = ['promotion-info', 'leaderboard', 'rules-content', 'prizes-content'];
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = `<div class="no-data">${message}</div>`;
                }
            });
        }

        function updatePromoImage() {
            const container = document.getElementById('promo-image');
            if (!container) return;

            const defaultImage = window.location.hostname === 'localhost' ? '/default-promo-image.jpg' : 'https://hammerhead-app-f4ysx.ondigitalocean.app/default-promo-image.jpg';
            const imageUrl = currentData.promoImage || defaultImage;
            container.innerHTML = `<img src="${imageUrl}" alt="Promotion Image" onerror="this.src='${defaultImage}'" />`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setInterval(fetchData, REFRESH_INTERVAL);
        });

        // Handle visibility change to refresh when tab becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                fetchData();
            }
        });
    </script>
</body>
</html>
